---
title: "SITCure Analysis"
author: "Sabina Kaczanowska"
date: "12/18/2019"
output:
  html_document:
    code_folding: hide
    
---
```{r setup, include=FALSE, echo=FALSE}
chooseCRANmirror(graphics=TRUE, ind=1)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r load libraries, include=FALSE, echo=FALSE}
library(rio)
library(tidyverse)
library(dplyr)
library(visdat)
library(tableone)
library(ggplot2)
library(ggfortify)
library(cowplot)
library(stringr)
library(ggpubr)
```

```{r load data, include=FALSE, echo=FALSE}
data <- import('Vanallen.csv')
```
## Immunotherapy of Cancer
Immunotherapy is a treatment that boosts the body's natural immune system to fight cancer

Checkpoint blockade is an approach that "takes off the brakes" of the immune system by using antibodies to block inhibitory signaling pathways in T cells to boost T cell responses against cancer

Two two most common approved checkpoint blockade therapies are anti-CTLA (Ipilimumab) and anti-PD1 (Nivolumab)

Clinical predictors of response to these therapies are not well characterized

Society for Immunotherapy of Cancer (SITC) Sparkathon 2018 SITCure Team

### Data Set Identified
Genomic correlates of response to CTLA-4 blockade in metastatic melanoma (Van Allen EM et al. Science 2015)

Data:

110 Melanoma Patients 

27 with Clinical Benefit from Ipi

```{r data structure}
vis_dat(data)
```

## Research Question: Is it safe to discontinue therapy?

#### 1) Identify responders >6 months

#### 2) Plot overall survival and progression-free survival by duration of treatment

#### 3) Look at time to death from end date of treatment


### Calculate Duration of Therapy
```{r tidy data, warning = FALSE, message = FALSE, echo=TRUE}
data$overall_survival <- as.numeric(data$overall_survival)
data$progression_free <- as.numeric(data$progression_free)
data$duration_of_therapy <- (as.Date(data$therapy_end, "%m/%d/%Y") - as.Date(data$therapy_start, "%m/%d/%Y"))
data$time_to_death <- (as.Date(data$date_death, "%m/%d/%Y") - as.Date(data$therapy_end, "%m/%d/%Y"))
data$duration_of_therapy <- as.numeric(data$duration_of_therapy)
data$time_to_death <- as.numeric(data$time_to_death)
vis_dat(data)
```

### Summarize Data
```{r summarize data, warning=FALSE}
summary <- data %>% 
  select(overall_survival, progression_free, duration_of_therapy, time_to_death)

Table1 <- CreateTableOne(data=summary[])
kableone(print(Table1, nonnormal = names(summary)[-1]),
         format='html')
```

```{r plot duration}
data$group <- factor(data$group, c('nonresponse','response','long-survival'))
ggplot(data, aes(x = group, y = duration_of_therapy, fill = group)) +
  geom_violin() +
  geom_point() +
  theme_classic() +
  labs(x = "Response Group", y = "Duration of Therapy (Days)", title = "Duration of Therapy by Response", caption = "Van Allen et al Science 2015")

stat <- aov(duration_of_therapy ~ group, data = data)
TukeyHSD(stat, format = 'html')
```


```{r plot data (days), include=FALSE, echo=FALSE}
ggplot(data, aes(x = overall_survival, y = duration_of_therapy, color = progression_free)) +
  geom_smooth(color = "black", method='lm') +
  geom_point() +
  theme_bw() +
  labs(x = "Overall Survival (Days)", y = "Duration of Therapy (Days)", title = "Overall Survival vs. Duration of Therapy", color ="Progression-Free Survival (Days)")

ggplot(data, aes(x = progression_free, y = duration_of_therapy, color = overall_survival)) +
  geom_smooth(color = "black", method='lm') +
  geom_point() +
  theme_bw() +
  labs(x = "Progression-Free Survival (Days)", y = "Duration of Therapy (Days)", title = "Progression-Free Survival vs. Duration of Therapy", color ="Overall Survival (Days)")

ggplot(data, aes(x = time_to_death, y = duration_of_therapy)) +
  geom_smooth(color = "black", method='lm') +
  geom_point() +
  theme_bw() +
  labs(x = "Time to Death After Cessation of Therapy (Days)", y = "Duration of Therapy (Days)", title = "Time to Death vs. Duration of Therapy")
```

### Convert Days to Months
```{r convert days to months, include=TRUE, echo=TRUE}
data$duration_of_therapy_month <- (data$duration_of_therapy/30.375)
data$time_to_death_month <- (data$time_to_death/30.375)
data$overall_survival_month <- (data$overall_survival/30.375)
data$progression_free_month <- (data$progression_free/30.375)
```

### Overall Survival
```{r plot data (months), message=FALSE, warning=FALSE, echo=FALSE}
ggplot(data, aes(x = overall_survival_month, y = duration_of_therapy_month, color = progression_free_month)) +
  geom_smooth(color = "black", method='lm') +
  geom_point() +
  theme_bw() +
  labs(x = "Overall Survival (Months)", y = "Duration of Therapy (Months)", title = "All Patients", color ="Progression-\nFree\nSurvival\n(Months)", caption = "Van Allen et al Science 2015")
```

### Progression-Free Survival
```{r, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(data, aes(x = progression_free_month, y = duration_of_therapy_month, color = overall_survival_month)) +
  geom_smooth(color = "black", method='lm') +
  geom_point() +
  theme_bw() +
  labs(x = "Progression-Free Survival (Months)", y = "Duration of Therapy (Months)", title = "All Patients", color ="Overall\nSurvival\n(Months)", caption = "Van Allen et al Science 2015") 
```

### Time to Death
```{r, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(data, aes(x = time_to_death_month, y = duration_of_therapy_month)) +
  geom_smooth(color = "black", method='lm') +
  geom_point() +
  theme_bw() +
  labs(x = "Time to Death After Cessation of Therapy (Months)", y = "Duration of Therapy (Months)", title = "All Patients", caption = "Van Allen et al Science 2015")
```

### Defining Long Term Responders
```{r define long term responders, include=TRUE, echo=TRUE}
Longterm_Resp <- filter(data, progression_free>=180) #estimating 6 months as 180 days
Not_Longterm_Resp <- filter(data,progression_free<180)
```

### Overall Survival for Long Term Responders
```{r graph longterm responders, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(Longterm_Resp, aes(x = overall_survival_month, y = duration_of_therapy_month, color = progression_free_month)) +
  geom_smooth(color = "black", method='lm') +
  geom_point() +
  theme_bw() +
  labs(x = "Overall Survival (Months)", y = "Duration of Therapy (Months)", title = ">6 Month Responders", color ="Progression-\nFree\nSurvival\n(Months)", caption = "Van Allen et al Science 2015")
```

### Progression-Free Survival for Long Term Responders
```{r, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(Longterm_Resp, aes(x = progression_free_month, y = duration_of_therapy_month, color = overall_survival_month)) +
  geom_smooth(color = "black", method='lm') +
  geom_point() +
  theme_bw() +
  labs(x = "Progression-Free Survival (Months)", y = "Duration of Therapy (Months)", title = ">6 Month Responders", color ="Overall\nSurvival\n(Months)", caption = "Van Allen et al Science 2015") 
```

### Time to Death for Long Term Responders
```{r, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(Longterm_Resp, aes(x = time_to_death_month, y = duration_of_therapy_month)) +
  geom_smooth(color = "black", method='lm') +
  geom_point() +
  theme_bw() +
  labs(x = "Time to Death After Cessation of Therapy (Months)", y = "Duration of Therapy (Months)", title = ">6 Month Responders", caption = "Van Allen et al Science 2015")
```

### Correlation Analysis
```{r correlation, echo = FALSE}
cor.OS <- cor.test(data$overall_survival, data$duration_of_therapy, method=c("pearson", "kendall", "spearman"))
cor.PFS <- cor.test(data$progression_free, data$duration_of_therapy, method=c("pearson", "kendall", "spearman"))
```

```{r table of correlation analysis, echo = TRUE}
cor.summary <- data.frame("Comparison" = c("Overall Survival", "Progression-Free Survival"), "p_value" = c(cor.OS$p.value, cor.PFS$p.value), "correlation coefficient" = c(cor.OS$estimate, cor.PFS$estimate))
head(cor.summary)
```

### Summary
Low but positive correlation coefficient, p value is significant

May suggest a trend but further analysis of more patients is necessary

```{r save new dataset, echo = FALSE}
write.csv(data, file ="VanAllen_SK")
```
