---
title: "Presentation_cuburu"
author: "Nicolas Cuburu"
date: "12/11/2019"
output: ioslides_presentation
---

## run library

```{r setup, echo=TRUE, include=FALSE, warning=FALSE}

library(tidyverse)
#> ── Attaching packages ────────────────────────────────── tidyverse 1.2.1 ──
#> ✔ ggplot2 3.1.0.9000     ✔ purrr   0.2.5     
#> ✔ tibble  2.0.0          ✔ dplyr   0.7.8     
#> ✔ tidyr   0.8.2          ✔ stringr 1.3.1     
#> ✔ readr   1.3.1          ✔ forcats 0.3.0
#> ── Conflicts ───────────────────────────────────── tidyverse_conflicts() ──
#> ✖ dplyr::filter() masks stats::filter()
#> ✖ dplyr::lag()    masks stats::lag()
library(rio)
library(cowplot)

knitr::opts_chunk$set()
```

## Introduction (1)

The goal here is to script the analysis of flow cytometry data.

I naalysis is becoming relies on using multiple software:
Flowjo, Excel,Prism, Powerpoint and a lot of copy pasting!

In order to be usable, I need to prepa my output file so that it includes more metadata into the data frame (treatments, staining, type of tissue).

## Introduction (2)

The reason to script  the final analysis of the FACS data is to:

- be able to analyse in a systematic manner flow cytometry data without the need of repeating the same actions (copy paste)

- minimize the risk of manipulation error 

- run automatically statistical analysis

- Generate presentable graph for lab meeting

- Provide a reliable and reprocible way to analyze Flow data


## Gating strategy

```{r}

FIG1 <- knitr::include_graphics('gating.jpg')

```

## FIG1

```{r}

FIG1

```


## Import data

```{r, echo=FALSE} 

## Import .xls flow cytometry files from data folder

blood_count <- import('blood_count.xls', skip=2)

blood_volume <- import('blood_volume.xls', skip=2)

blood <- import('blood.xls', skip=2)

str(blood_count)
str(blood_volume)
str(blood)
```


##join dataframes

```{r}

## I used outer join to have all blood volume and flowcytometry dataframes together

blood_count_merge <- merge(x = blood_count, y = blood_volume, all = TRUE)

## checked the variables in the dataframes
str(blood_count_merge)
str(blood)
```


## Modify variables {.smaller}

```{r}

# modified character as factor or numeric (numeric did force missing values into NA)

blood$treatment <- as.factor(blood$treatment)
blood$Staining <- as.factor(blood$Staining)
blood$intratumoral <- as.factor(blood$intratumoral)
```

## Modify variables {.smaller}

```{r}

# modified character as factor or numeric (numeric did force missing values into NA)

blood$Cage <- as.character(blood$Cage)
blood$MHC2_PD1_MFI <- as.numeric(blood$MHC2_PD1_MFI)
blood$MHC2_CD62L_MFI <- as.numeric(blood$MHC2_CD62L_MFI)
blood$MHC2_CD44_MFI <- as.numeric(blood$MHC2_CD44_MFI)
blood$MHC1_PD1_MFI <- as.numeric(blood$MHC1_PD1_MFI)
blood$MHC1_CD62L_MFI <- as.numeric(blood$MHC1_CD62L_MFI)
blood$MHC1_CD44_MFI <- as.numeric(blood$MHC1_CD44_MFI)

```


## Modify variables {.smaller}

```{r}

# modified character as factor or numeric (numeric did force missing values into NA)

blood_count_merge$treatment <- as.factor(blood_count_merge$treatment)
blood_count_merge$intratumoral <- as.factor(blood_count_merge$intratumoral)
blood_count_merge$Staining <- as.factor(blood_count_merge$Staining)
blood_count_merge$Cage <- as.character(blood_count_merge$Cage)

```


##check dataframes

```{r}

# Checked that variables were transformed

str(blood)
str(blood_count_merge)
```



##transform data to count per ml {.smaller}

```{r}

# each variable count was adjusted so that the count were expressed by ml of blood 
# (the same could be used to express the data by miligram of tumor tissue)
# piped it so that it reduced the amount of code

blood_count_merge <- blood_count_merge %>% mutate(CD45 = 1000 * CD45/blood_plasma) %>% mutate(CD4 = 1000 * CD4/blood_plasma) %>% mutate(CD4_TET = 1000 * CD4_TET/blood_plasma) %>% mutate(CD8 = 1000 * CD8/blood_plasma) %>% mutate(CD8_TET = 1000 * CD8_TET/blood_plasma)

str(blood_count_merge)

```


## test plotting {.smaller}

```{r}

# comparison intratumoral for CD4_TET variable; basic ggplot was not informative 
# as all metada were merged into one group 

FIG2 <- ggplot(data = blood_count_merge,
       aes(x = intratumoral,
           y = CD4_TET)) +
  geom_boxplot() + 
  geom_jitter()

```

## FIG2

```{r}


FIG2

```

## analysis CD45 according to treatment, staining and intratumoral 

```{R}

# generated a plot that is grouped according to intratumoral 
# facetted according to staining

data <- subset(blood_count_merge, !is.na(blood_count_merge$treatment)) 

FIG3 <- ggplot(data, aes(x=intratumoral, y=CD45, fill=treatment)) + 
    geom_boxplot() + facet_wrap( ~ Staining, ncol=2)

```

## FIG3 

```{R}


FIG3 

```

## analysis CD4 according to treatment, staining and intratumoral 

```{R}

# copied the same code for each variable and replaced variable accordingly

data <- subset(blood_count_merge, !is.na(blood_count_merge$treatment)) 

FIG4 <- ggplot(data, aes(x=intratumoral, y=CD4, fill=treatment)) + 
    geom_boxplot() + facet_wrap( ~ Staining, ncol=2)

```

## FIG4 

```{R}

FIG4 

```

## analysis CD4_TET according to treatment, staining and intratumoral 

```{R}

data <- subset(blood_count_merge, !is.na(blood_count_merge$treatment)) 

FIG5 <- ggplot(data, aes(x=intratumoral, y=CD4_TET, fill=treatment)) + 
    geom_boxplot() + facet_wrap( ~ Staining, ncol=2)

```

## FIG5 

```{R}

FIG5 

```

## analysis CD8 according to treatment, staining and intratumoral 

```{R}

data <- subset(blood_count_merge, !is.na(blood_count_merge$treatment)) 

FIG6 <- ggplot(data, aes(x=intratumoral, y=CD8, fill=treatment)) + 
    geom_boxplot() + facet_wrap( ~ Staining, ncol=2)

```


## FIG6 

```{R}

FIG6

```

## analysis CD8_TET according to treatment, staining and intratumoral 

```{R}

data <- subset(blood_count_merge, !is.na(blood_count_merge$treatment)) 

FIG7 <- ggplot(data, aes(x=intratumoral, y=CD8_TET, fill=treatment)) + 
    geom_boxplot() + facet_wrap( ~ Staining, ncol=2)

```

## FIG7 

```{R}

FIG7

```