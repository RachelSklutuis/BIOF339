---
title: "Homework 3: Data ingestion and munging"
author: ""
date: "Due September 24, 2019"
output: html_document
---

<p style="color: black; border:3px; border-style: solid; border-color: red; padding: 1em; background-color: wheat;font-size: 14pt;text-align:center">
[**Submission Link**](https://www.dropbox.com/request/9AppRTALBcboUsnblpwF){target=_blank}
</p>

## Homework

Create a fresh RMarkdown document to do this homework and submit at the link above when done.


The weather dataset, available [here](data/weather.xlsx) contains max and min temperatures for a location during the
year 2010.

1. Write code to ingest this dataset into R. Activate the appropriate package(s) first using `library(...)`. 

```{r, message=F}
library(tidyverse)
library(rio)
weather <- import('data/weather.xlsx', skip = 1)
```

Question 1. Identify and write down the ways in which this dataset is not tidy

**Solution: ** This data is not tidy for the following reasons:

1. The observational unit in this data is a day 
1. Data for different days are stored as columns, whereas in a tidy data set observations are stored in rows
1. Data on the maximum and minimum temperatures for each day are stored in separate rows, even though they are from the same observational unit, days. In a tidy dataset, data from each observational unit fills one row.
1. The data on days is not computable since it is attached to the character "d"



Question 2.  Use the functions `gather`, `spread` and `separate` to make this dataset tidy. Make sure you activate the right package(s) first. (Advice: use `gather` first).

```{r}
weather1 <- tidyr::gather(weather, key='day', value = 'temp', -(1:4))
weather2 <- spread(weather1, key = 'element', value = 'temp')
weather3 <- separate(weather2, col='day', into = c('symbol','day'), sep = 1,
                     convert = T) # This converts potentially numeric variables to numeric
str(weather3)
```

> The `convert=T` option in `separate` automatically converted the `day` variable to numeric, rather than keep it a character variable, which is the default. 

### Extra credit

The dataset `who` in the `tidyr` package gives a subset of data from the World Health Organization Global Tuberculosis Report, and accompanying global populations. (You must do `library(tidyr)` first before you can access the data)

1. Read the documentation for this dataset (`?who`) to understand the variables
1. Attempt to make this dataset tidy

## General advice

Open a R script file and do the R work you need first, which will involve trial
and error. Once you think you have got your solution, open a RMarkdown file, put
the parts of your code you think are relevant into R chunks, and include text to
make a report. Then you can submit that RMarkdown file. This is often the
workflow I use for developing reports.

```{r}
library(tidyr)
library(tidyverse)

head(who)
```

```{r}
who2 <- tidyr::gather(who, key = "variable", value = "TB", -(1:4))
who3 <- separate(who2, col='variable', 
                 into = c('new','diagnosis','age_sex'), 
                 sep='_')
```

The error shows that for some values of `variable`, splitting on the `_` character doesn't create 3 quantities, which we expect. We need to look further.

```{r}
unique(who2$variable)
```

Ahh!! There's the problem. Some of the observations are missing the `_` after the `new`.  Notice the issue is only for the `rel` diagnosis, so they were coded `newrel` as opposed to `new_rel`. We can use a find-and-replace function to fix that.

```{r}
who2$variable <- str_replace(who2$variable, 'newrel','new_rel')
```

Now let's continue our data cleaning.

```{r}
who3 <- separate(who2, col='variable', 
                 into = c('new','diagnosis','age_sex'), 
                 sep = '_')
head(who3)
```

We now need to separate the age and sex variables.

```{r}
who4 <- separate(who3, col = 'age_sex',
                 into = c('sex','agegrp'),
                 sep = 1)
head(who4)
```

This makes our data tidy. We could be done here.

If we want to make this cleaner, we can take some more steps. I'll write them
out as a pipe. 

```{r}
who_clean <- who %>% 
  tidyr::gather(key='variable',value="TB", -(1:4)) %>% 
  mutate(variable = str_replace(variable, 'newrel','new_rel')) %>% 
  separate(col = 'variable', into = c('new','diagnosis','age_sex')) %>% 
  separate(col = 'age_sex', into = c('sex','agegrp'), sep = 1) %>% 
  select(-new) %>% 
  mutate(agegrp = case_when(agegrp=='014' ~ '0 - 14',
                            agegrp=='1524' ~ '15 - 24',
                            agegrp=='2534' ~ '25 - 34',
                            agegrp=='3544' ~ '35 - 44',
                            agegrp=='4554' ~ '45 - 54',
                            agegrp=='5564' ~ '55 - 64',
                            agegrp=='65' ~ '65 +'))
head(who_clean)
```

We can now work with this dataset. Play around with other summaries of this data. We'll  use it in part for our plotting lectures. 
